import React, {useEffect, Fragment} from 'react'
import {stringify} from 'query-string';
import PopularTags from 'components/popularTags';

import useFetch from 'hooks/useFetch';
import Feed from 'components/feed';
import Pagination from 'components/pagination';
import {getPaginator, limit} from 'utils/utils';
import Loading from 'components/loading';
import ErrorMessage from 'components/errorMessage';
import FeedToggler from 'components/feedToggler';

const TagFeed = ({location, match}) => {
	const tagName = match.params.slug;
	const {currentPage, offset} = getPaginator(location.search)
	const stringifiedParams = stringify({ limit, offset, tag: tagName });

	const apiUrl = `/articles?${stringifiedParams}`;

	const [{response, isLoading, errorsObj}, doFetch] = useFetch(apiUrl);

	useEffect(() => {
		doFetch()
	}, [doFetch, currentPage, tagName])

	return (
		<section className='home-page'>
			<section className='banner'>
				<div className='container'>
					<h1>Medium clone</h1>
					<p>A place to share knowledge!</p>
				</div>
			</section>
			<div className='container page'>
				<div className='row'>
					<div className='col-md-9'>
						<FeedToggler tagName={tagName} />
						{isLoading && <Loading />}
						{errorsObj && <ErrorMessage />}
						{!isLoading && response && (
							<Fragment>
							  <Feed articles={ response.articles } />
							  <Pagination total={response.articlesCount} limit={limit} url='/' currentPage={currentPage} />							
							</Fragment>
						)}
					</div>
					<div className='col-md-3'>
						<PopularTags />
					</div>
				</div>
			</div>
		</section>
	)
}

export default TagFeed;