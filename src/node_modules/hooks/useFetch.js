// Хук для соединение с сервером, получения ошибок и авторизации
// 1. Принимает на вход api url
// 2. Посылает запрос с информацией из 'doFetch' (или с пустым объектом для ре-рендеринга)
// 3. Обрабатывает ответ

import { useState, useEffect, useCallback } from 'react';
import axios from 'axios';

import useLocalStorage from 'hooks/useLocalStorage';

export default (url) => {
  const baseUrl = 'https://conduit.productionready.io/api';
  const [token] = useLocalStorage('token');

  // Для запросов статей/страниц***
  const [isLoading, setIsLoading] = useState(false);
  const [response, setResponse] = useState(null);
  const [errorsObj, setError] = useState(null);

  // Создаем 'state' для передачи 'options' из 'doFetch' в 'request'
  const [options, setOptions] = useState({});
  // 'options' содержат информацию с полей ввода
  const doFetch = useCallback((options = {}) => {
  	setOptions(options);
  	setIsLoading(true);
  }, [])

	useEffect(() => {
		// Добавляем токен юзера к его данным авторизации
		const requestOptions = {
		  ...options,
		  ...{
		  	headers: {
		  		authorization: token ? `Token ${token}` : ''
		  	}
		  }
		}

		if(!isLoading) {
			return
		}

		axios(baseUrl + url, requestOptions)
		.then((res) => {
			setIsLoading(false);
			setResponse(res.data);
		})
		.catch((err) => {
			console.log(err)
			setIsLoading(false);
			setError(err.response.data);
		})
	}, [isLoading, options, url, token]);
  
  return [ {isLoading, response, errorsObj}, doFetch ];
}